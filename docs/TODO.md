# TODO 列表（结合课题目标与当前实现）

## Bug 修复
- [ ] **swap_tokens 死锁问题**：在 `src/simulation/ledger.py:277-279` 中，`swap_tokens` 函数在持有 `self._lock` 的情况下调用 `await self.get_token_price()`，而 `get_token_price()` 也会尝试获取同一个锁，导致死锁。解决方案：创建一个不需要获取锁的内部版本 `_get_token_price_unlocked()` 供内部调用。

## 数据与环境（社交舆情 + 链上账本）
- [ ] 舆情数据完善：补充更丰富的正/负面、多模态推文样本（含虚假信息案例），标注情绪/可信度元数据；支持按情绪/来源过滤检索。
- [ ] 链上仿真增强：为账本增加更丰富的合约状态/事件，补充多网络/多代币样例；在 RAG/防御中明确“链上为事实基准”的提示与使用流程。
- [ ] 数据注入工具：提供脚本/前端入口快速增量导入舆情文档与图片，便于构造攻击样本。

## Agent 与 RAG（已部分实现：本地 Chroma、tweets 注入、tools/RAG 自动串联）
- [ ] RAG 召回质量：增加检索重排/去重，命中文档与来源在 trace/UI 中展示；支持按情绪/可信度过滤（利用元数据）。
- [ ] 投毒防护：对 unsafe 语料做基础检测（长度/关键词/来源黑名单），命中时在回复中显式提示风险；设计"高权重伪造文本"注入剧本并验证防御。
- [ ] 情绪分析/决策演示：在回复中显式展示情绪判断与决策依据（RAG / 链上快照 / 视觉判定），以支撑"模拟交易决策"场景。

## 记忆持久化（已重构：全局共享架构 + 访问计数 + 自动清理）
- [x] ChromaDB 持久化：对话历史存储到全局共享集合（`web3-memory-{lane}` 或 `web3-memory`），独立存储目录 `./data/memory/`。
- [x] CRUD 操作：完整的增删改查功能，包括 `add_user_message()`, `add_ai_message()`, `delete_message()`, `edit_message()`, `get_message()`。
- [x] 语义搜索：支持基于嵌入向量的语义检索历史对话，可通过 `search_messages(query, n_results, role_filter)` 调用，搜索时自动更新访问计数。
- [x] 访问计数：追踪消息访问次数（`access_count`, `last_accessed_at`），支持 `increment_access()`, `batch_increment_access()`, `get_access_stats()`。
- [x] 自动清理：基于访问次数和时间的清理机制，删除超过保留天数且访问次数少的消息，支持启动时/定时/手动三种触发模式。
- [x] 前端集成：会话切换时无需重建记忆（全局共享），支持多会话管理。
- [x] 向后兼容：通过 `MEMORY_USE_PERSISTENT` 环境变量控制，可随时回退到 `SimpleChatMemory`。
- [ ] 记忆摘要：长对话自动摘要，减少上下文长度（未来）。
- [ ] 前端管理界面：可视化的记忆搜索、编辑和删除功能（未来）。

## 视觉一致性（已实现：本地 Florence Caption + 远程文本判定，可选远程多模态，模式由 `VISION_PIPELINE_MODE` 控制）
- [ ] 远程文本判定稳健化：为 `VISION_REMOTE_TEXT_*` 调用增加超时、重试、失败回退策略；记录使用路径与结果到 trace。
- [ ] 多模态直判完善：为 `VISION_REMOTE_MM_*`（glm-4v-flash）增加频控/失败回退（如失败时标记 ERROR，不阻塞主流程）；可选比对多次采样或置信度。
- [ ] 防护与校验：对空/极短 caption 或异常响应直接标记 ERROR；可选双模型互证（文本判定 + 多模态互相佐证）。

## 攻击场景与演示（已具备内存注入、RAG 投毒按钮）
- [ ] 扩充攻击剧本：添加“高权重跑路伪造文本”与“图文不符趋势图”示例；在控制台一键触发并对比有/无防御下的决策差异。
- [ ] 记忆篡改/提示注入：设计对话式注入案例，观察防御链路响应；必要时增加上下文清洗/截断策略。

## 防御框架与安全策略
- [ ] 链上-链下一致性核查：在高风险舆情场景中，自动调用链上工具核查关键实体/资金流，若冲突则显式拦截或警示。
- [ ] 安全策略收敛：为工具调用加白名单/风险分级，异常时阻断或降级；为视觉/远程调用增加速率与并发限制。

## 前端与体验（已实现基础双通道 UI）
- [x] 流式/状态提示：支持 token 级流式输出（LLM stream，可开关）+ “Generating…” 状态，减少等待空白。
- [x] 调试视图结构化：分区展示 Trace/Chain/RAG/LLM/Flow，并标注 vision 状态。
- [ ] RAG/视觉来源展示：在回复中或 UI 区域列出命中文档/图片来源与判定结果。
- [x] 实时链路可视化：展示每轮 LLM 输入输出与 tool_call/工具结果（见 Debug/Flow），便于调试和演示。
- [x] 前端体验优化：使用 Streamlit Chat 组件、会话列表/导出、图片附件，减少 CSS hack 依赖。
- [ ] 性能与稳定性：为图片上传/展示与长对话做体积限制与缓存/截断策略，避免页面卡顿与状态错乱。

## 观察与运维
- [ ] 健康/就绪探针：为前端补充探针；MCP/前端日志输出路径与滚动策略。
- [ ] 基础指标：记录工具成功率、视觉判定通过率、RAG 命中率到日志或简单 metrics 端点（可先文本日志）。

## 测试与 CI
- [ ] 扩充 `scripts/test_mcp_tools.py` 覆盖主要工具与异常路径。
- [ ] 视觉/RAG 集成测试：使用固定图片+描述与固定检索语料，验证判定与命中结果；可在 CI 中跑最小无网用例。
